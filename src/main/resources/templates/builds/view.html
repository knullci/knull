<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:text="'Build #' + ${build.id} + ' - Knull CI'">Build Details</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <style>
        .build-section {
            display: none;
        }

        .build-section.active {
            display: block;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800" th:with="section=${activeSection} ?: 'overview'"
    th:attr="data-build-status=${build.status.name()}">

    <!-- Page Container (dedicated layout: no main nav) -->
    <div class="flex min-h-screen gap-0">
        <!-- Enhanced Build Detail Side Navigation -->
        <div class="w-64 bg-white border-r border-gray-200 fixed left-0 top-0 bottom-0 overflow-y-auto shadow-lg">
            <!-- Logo Section -->
            <div class="p-6 border-b border-gray-200 bg-gradient-to-br">
                <div class="flex items-center gap-3">
                    <!-- Custom Knull CI Logo -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 100 100" fill="none">
                        <!-- Gradient Definitions -->
                        <defs>
                            <linearGradient id="knullGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#3B82F6;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#6366F1;stop-opacity:1" />
                            </linearGradient>
                        </defs>

                        <!-- Outer Circle (Pipeline Ring) -->
                        <circle cx="50" cy="50" r="45" stroke="url(#knullGradient)" stroke-width="3" fill="none"
                            opacity="0.3" />

                        <!-- Stylized 'K' with Circuit Elements -->
                        <!-- Vertical bar of K -->
                        <rect x="25" y="25" width="8" height="50" fill="url(#knullGradient)" rx="2" />

                        <!-- Upper diagonal of K with nodes -->
                        <path d="M33 40 L55 25" stroke="url(#knullGradient)" stroke-width="8" stroke-linecap="round" />
                        <circle cx="55" cy="25" r="5" fill="#3B82F6" />
                        <circle cx="55" cy="25" r="3" fill="white" />

                        <!-- Lower diagonal of K with nodes -->
                        <path d="M33 60 L55 75" stroke="url(#knullGradient)" stroke-width="8" stroke-linecap="round" />
                        <circle cx="55" cy="75" r="5" fill="#6366F1" />
                        <circle cx="55" cy="75" r="3" fill="white" />

                        <!-- Pipeline flow indicators (dots) -->
                        <circle cx="70" cy="30" r="3" fill="#3B82F6" opacity="0.6" />
                        <circle cx="75" cy="50" r="3" fill="#6366F1" opacity="0.6" />
                        <circle cx="70" cy="70" r="3" fill="#3B82F6" opacity="0.6" />

                        <!-- Connection lines (representing CI/CD flow) -->
                        <path d="M55 25 L70 30" stroke="#3B82F6" stroke-width="2" opacity="0.4"
                            stroke-dasharray="2,2" />
                        <path d="M55 75 L70 70" stroke="#6366F1" stroke-width="2" opacity="0.4"
                            stroke-dasharray="2,2" />
                    </svg>

                    <div class="flex flex-col">
                        <span class="text-xl font-bold tracking-tight text-gray-900">
                            Knull<span class="text-blue-600">CI</span>
                        </span>
                        <span class="text-xs text-gray-500 font-medium">Continuous Integration</span>
                    </div>
                </div>
            </div>

            <!-- Build Header with Enhanced Status -->
            <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-br from-gray-50 to-white">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-bold text-gray-900">Build <span th:text="${build.id}"></span></h3>
                    <!-- Build Navigation Arrows -->
                    <div class="flex items-center gap-1">
                        <a th:href="@{|/builds/${build.id - 1}/overview|}"
                            class="p-1.5 text-gray-400 hover:text-gray-700 hover:bg-gray-100 rounded transition-all"
                            title="Previous Build">
                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 19l-7-7 7-7" />
                            </svg>
                        </a>
                        <a th:href="@{|/builds/${build.id + 1}/overview|}"
                            class="p-1.5 text-gray-400 hover:text-gray-700 hover:bg-gray-100 rounded transition-all"
                            title="Next Build">
                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5l7 7-7 7" />
                            </svg>
                        </a>
                    </div>
                </div>
                <span
                    class="build-status-badge inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-bold rounded-full"
                    th:text="${build.status.name() == 'SUCCESS' ? '✓ Success' : (build.status.name() == 'FAILURE' ? '✗ Failed' : (build.status.name() == 'IN_PROGRESS' ? '⟳ In Progress' : (build.status.name() == 'PENDING' ? '○ Pending' : '⊘ Skipped')))}"
                    th:classappend="${build.status.name() == 'SUCCESS' ? ' bg-green-100 text-green-700 border border-green-300' : (build.status.name() == 'FAILURE' ? ' bg-red-100 text-red-700 border border-red-300' : (build.status.name() == 'IN_PROGRESS' ? ' bg-blue-100 text-blue-700 border border-blue-300' : (build.status.name() == 'PENDING' ? ' bg-yellow-100 text-yellow-700 border border-yellow-300' : ' bg-gray-100 text-gray-700 border border-gray-300')))}"></span>
            </div>

            <!-- Enhanced Side Navigation -->
            <nav class="px-4 py-5 space-y-1.5" aria-label="Build sections">
                <a th:href="@{|/builds/${build.id}/overview|}"
                    class="group flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200"
                    th:classappend="${section == 'overview'} ? ' bg-blue-50 text-blue-700 shadow-sm' : ' text-gray-700 hover:text-gray-900 hover:bg-gray-100'">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    <span>Overview</span>
                </a>
                <a th:href="@{|/builds/${build.id}/pipeline|}"
                    class="group flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200 text-blue-600 hover:text-blue-800 hover:bg-blue-50 font-semibold border-2 border-blue-200 hover:border-blue-300">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <span>Pipeline View</span>
                </a>
                <a th:href="@{|/builds/${build.id}/steps|}"
                    class="group flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200"
                    th:classappend="${section == 'steps'} ? ' bg-blue-50 text-blue-700 shadow-sm' : ' text-gray-700 hover:text-gray-900 hover:bg-gray-100'">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                    </svg>
                    <span>Build Steps</span>
                </a>
                <a th:href="@{|/builds/${build.id}/logs|}"
                    class="group flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200"
                    th:classappend="${section == 'logs'} ? ' bg-blue-50 text-blue-700 shadow-sm' : ' text-gray-700 hover:text-gray-900 hover:bg-gray-100'">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span>Full Logs</span>
                </a>
            </nav>

            <!-- Enhanced Build Metadata -->
            <div class="px-6 py-5 border-t border-gray-200 bg-gray-50">
                <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-4">Build Details</h4>
                <dl class="space-y-4">
                    <div>
                        <dt class="text-xs font-semibold text-gray-500 mb-1 flex items-center gap-1.5">
                            <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                            </svg>
                            Repository
                        </dt>
                        <dd class="text-sm font-medium text-gray-900 truncate bg-white px-2 py-1.5 rounded border border-gray-200"
                            th:title="${build.repositoryOwner + '/' + build.repositoryName}"
                            th:text="${build.repositoryOwner + '/' + build.repositoryName}"></dd>
                    </div>
                    <div>
                        <dt class="text-xs font-semibold text-gray-500 mb-1 flex items-center gap-1.5">
                            <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                            </svg>
                            Branch
                        </dt>
                        <dd class="text-sm font-medium text-gray-900 truncate bg-white px-2 py-1.5 rounded border border-gray-200"
                            th:title="${build.branch}" th:text="${build.branch}"></dd>
                    </div>
                    <div>
                        <dt class="text-xs font-semibold text-gray-500 mb-1 flex items-center gap-1.5">
                            <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                            </svg>
                            Commit
                        </dt>
                        <dd class="text-xs font-mono font-semibold text-gray-900 truncate bg-white px-2 py-1.5 rounded border border-gray-200"
                            th:title="${build.commitSha}" th:text="${#strings.substring(build.commitSha, 0, 7)}"></dd>
                    </div>
                </dl>
            </div>

            <!-- Back Button -->
            <div class="px-6 py-5 border-t border-gray-200">
                <a th:href="@{/builds}"
                    class="flex items-center justify-center gap-2 w-full px-4 py-2.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:border-gray-400 transition-all duration-200">
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to All Builds
                </a>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 ml-64">
            <!-- Enhanced Sticky Header with Gradient -->
            <div class="bg-gradient-to-r from-white to-gray-50 border-b border-gray-200 sticky top-0 z-10 shadow-md">
                <div class="px-8 py-6">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-4 mb-2">
                                <h1 class="text-4xl font-bold text-gray-900" th:text="'Build #' + ${build.id}"></h1>
                                <span id="build-status-badge"
                                    class="build-status-badge inline-flex items-center gap-1.5 px-4 py-2 text-sm font-bold rounded-full border-2 shadow-sm"
                                    th:text="${build.status.name() == 'SUCCESS' ? '✓ Success' : (build.status.name() == 'FAILURE' ? '✗ Failed' : (build.status.name() == 'IN_PROGRESS' ? '⟳ In Progress' : build.status.name()))}"
                                    th:classappend="${build.status.name() == 'SUCCESS' ? ' bg-green-50 text-green-700 border-green-300' : (build.status.name() == 'FAILURE' ? ' bg-red-50 text-red-700 border-red-300' : (build.status.name() == 'IN_PROGRESS' ? ' bg-blue-50 text-blue-700 border-blue-300 animate-pulse' : ' bg-gray-50 text-gray-700 border-gray-300'))}">
                                </span>
                            </div>
                            <div class="flex items-center gap-4 text-sm text-gray-600">
                                <span class="flex items-center gap-1.5 font-medium">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                    </svg>
                                    <span th:text="${build.jobName}">Job Name</span>
                                </span>
                                <span class="text-gray-400">•</span>
                                <span class="flex items-center gap-1.5">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <span
                                        th:text="${build.startedAt != null ? #dates.format(build.startedAt, 'MMM dd, yyyy HH:mm') : 'Not started'}">Jan
                                        01,
                                        2024 12:00</span>
                                </span>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="location.reload()"
                                class="flex items-center gap-2 px-4 py-2.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:border-gray-400 transition-all duration-200 shadow-sm">
                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page Content -->
            <div class="p-8 bg-gray-50 min-h-screen">
                <div class="max-w-7xl mx-auto">

                    <!-- Breadcrumbs with Icons -->
                    <nav class="flex items-center gap-2 text-sm text-gray-500 mb-8" aria-label="Breadcrumb">
                        <a th:href="@{/}" class="flex items-center gap-1 hover:text-gray-700 transition-colors">
                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                            </svg>
                            Home
                        </a>
                        <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                        <a th:href="@{/builds}" class="hover:text-gray-700 transition-colors">Builds</a>
                        <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                        <a th:href="@{|/builds/${build.id}/overview|}" class="hover:text-gray-700 transition-colors"
                            th:text="'Build #' + ${build.id}"></a>
                        <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                        <span class="text-gray-700 font-semibold"
                            th:text="${section == 'overview'} ? 'Overview' : (${section == 'steps'} ? 'Build Steps' : (${section == 'logs'} ? 'Full Logs' : 'Pipeline'))"></span>
                    </nav>

                    <!-- Premium Pipeline Section -->
                    <section id="pipeline" class="build-section"
                        th:classappend="${section == 'pipeline'} ? ' active' : ''">

                        <!-- Premium Header with Gradient -->
                        <div class="flex items-center justify-between mb-8">
                            <div>
                                <h2
                                    class="text-3xl font-bold bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 bg-clip-text text-transparent mb-2">
                                    Pipeline Visualization
                                </h2>
                                <p class="text-gray-600">Real-time execution flow</p>
                            </div>
                        </div>

                        <div th:if="${build.steps != null && !build.steps.empty}">
                            <!-- Premium Stats Dashboard -->
                            <div class="grid grid-cols-4 gap-4 mb-8">
                                <div
                                    class="relative overflow-hidden rounded-xl p-6 bg-gradient-to-br from-green-500 to-emerald-600 text-white shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
                                    <div
                                        class="absolute top-0 right-0 -mt-4 -mr-4 h-24 w-24 rounded-full bg-white opacity-10">
                                    </div>
                                    <div class="relative">
                                        <svg class="h-8 w-8 mb-2 opacity-90" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        <p class="text-3xl font-bold" id="summary-success-count"
                                            th:text="${#lists.size(build.steps.?[status.name() == 'SUCCESS'])}">0</p>
                                        <p class="text-sm opacity-90 font-medium">Successful</p>
                                    </div>
                                </div>

                                <div
                                    class="relative overflow-hidden rounded-xl p-6 bg-gradient-to-br from-red-500 to-pink-600 text-white shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
                                    <div
                                        class="absolute top-0 right-0 -mt-4 -mr-4 h-24 w-24 rounded-full bg-white opacity-10">
                                    </div>
                                    <div class="relative">
                                        <svg class="h-8 w-8 mb-2 opacity-90" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                        <p class="text-3xl font-bold" id="summary-failed-count"
                                            th:text="${#lists.size(build.steps.?[status.name() == 'FAILURE'])}">0</p>
                                        <p class="text-sm opacity-90 font-medium">Failed</p>
                                    </div>
                                </div>

                                <div
                                    class="relative overflow-hidden rounded-xl p-6 bg-gradient-to-br from-blue-500 to-cyan-600 text-white shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
                                    <div
                                        class="absolute top-0 right-0 -mt-4 -mr-4 h-24 w-24 rounded-full bg-white opacity-10 animate-pulse">
                                    </div>
                                    <div class="relative">
                                        <svg class="h-8 w-8 mb-2 opacity-90 animate-spin" fill="none"
                                            stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                            </path>
                                        </svg>
                                        <p class="text-3xl font-bold" id="summary-running-count"
                                            th:text="${#lists.size(build.steps.?[status.name() == 'IN_PROGRESS'])}">0
                                        </p>
                                        <p class="text-sm opacity-90 font-medium">Running</p>
                                    </div>
                                </div>

                                <div
                                    class="relative overflow-hidden rounded-xl p-6 bg-gradient-to-br from-gray-500 to-gray-600 text-white shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
                                    <div
                                        class="absolute top-0 right-0 -mt-4 -mr-4 h-24 w-24 rounded-full bg-white opacity-10">
                                    </div>
                                    <div class="relative">
                                        <svg class="h-8 w-8 mb-2 opacity-90" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <p class="text-3xl font-bold" id="summary-pending-count"
                                            th:text="${#lists.size(build.steps.?[status.name() == 'PENDING'])}">0</p>
                                        <p class="text-sm opacity-90 font-medium">Pending</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Premium Vertical Pipeline Flow -->
                            <div class="relative">
                                <!-- Animated Background Gradient -->
                                <div
                                    class="absolute inset-0 bg-gradient-to-b from-blue-50 via-purple-50 to-pink-50 rounded-2xl opacity-30">
                                </div>

                                <div class="relative space-y-4 p-6">
                                    <div th:each="step, iter : ${build.steps}" class="pipeline-step-card group"
                                        th:attr="data-pipeline-step-index=${iter.index}">

                                        <!-- Step Card with Glassmorphism -->
                                        <div class="relative flex items-start gap-6 p-6 rounded-2xl backdrop-blur-sm bg-white/80 border border-white/60 shadow-xl hover:shadow-2xl transition-all duration-500 hover:scale-[1.02] cursor-pointer"
                                            th:classappend="${step.status.name() == 'SUCCESS'} ? ' border-l-4 border-l-green-500' :
                                                         (${step.status.name() == 'FAILURE'} ? ' border-l-4 border-l-red-500' :
                                                         (${step.status.name() == 'IN_PROGRESS'} ? ' border-l-4 border-l-blue-500 animate-pulse' : ' border-l-4 border-l-gray-300'))">

                                            <!-- Step Number with Premium Design -->
                                            <div class="flex-shrink-0">
                                                <div class="relative w-16 h-16 rounded-2xl flex items-center justify-center font-bold text-xl shadow-lg transform transition-transform duration-300 group-hover:scale-110"
                                                    th:classappend="${step.status.name() == 'SUCCESS'} ? ' bg-gradient-to-br from-green-400 to-emerald-600 text-white' :
                                                                 (${step.status.name() == 'FAILURE'} ? ' bg-gradient-to-br from-red-400 to-pink-600 text-white' :
                                                                 (${step.status.name() == 'IN_PROGRESS'} ? ' bg-gradient-to-br from-blue-400 to-cyan-600 text-white' : ' bg-gradient-to-br from-gray-300 to-gray-400 text-gray-700'))">
                                                    <span th:text="${iter.count}">1</span>

                                                    <!-- Animated Ring for Running Steps -->
                                                    <div th:if="${step.status.name() == 'IN_PROGRESS'}"
                                                        class="absolute inset-0 rounded-2xl border-4 border-blue-400 animate-ping opacity-75">
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Step Content -->
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-start justify-between gap-4 mb-3">
                                                    <div class="flex-1">
                                                        <h3 class="text-xl font-bold text-gray-900 mb-1"
                                                            th:text="${step.name}">Step Name</h3>
                                                        <div class="flex items-center gap-3 text-sm">
                                                            <span
                                                                class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full font-semibold"
                                                                th:classappend="${step.status.name() == 'SUCCESS'} ? ' bg-green-100 text-green-700' :
                                                                              (${step.status.name() == 'FAILURE'} ? ' bg-red-100 text-red-700' :
                                                                              (${step.status.name() == 'IN_PROGRESS'} ? ' bg-blue-100 text-blue-700' : ' bg-gray-100 text-gray-700'))">
                                                                <svg th:if="${step.status.name() == 'SUCCESS'}"
                                                                    class="h-4 w-4" fill="currentColor"
                                                                    viewBox="0 0 20 20">
                                                                    <path fill-rule="evenodd"
                                                                        d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                                                        clip-rule="evenodd"></path>
                                                                </svg>
                                                                <svg th:if="${step.status.name() == 'FAILURE'}"
                                                                    class="h-4 w-4" fill="currentColor"
                                                                    viewBox="0 0 20 20">
                                                                    <path fill-rule="evenodd"
                                                                        d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                                                                        clip-rule="evenodd"></path>
                                                                </svg>
                                                                <svg th:if="${step.status.name() == 'IN_PROGRESS'}"
                                                                    class="h-4 w-4 animate-spin" fill="none"
                                                                    stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                                        stroke-width="2"
                                                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                                                    </path>
                                                                </svg>
                                                                <span class="pipeline-step-status"
                                                                    th:text="${step.status.name() == 'SUCCESS'} ? 'Success' : (${step.status.name() == 'FAILURE'} ? 'Failed' : (${step.status.name() == 'IN_PROGRESS'} ? 'Running' : 'Pending'))">Success</span>
                                                            </span>
                                                            <span
                                                                class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-gray-100 text-gray-700 font-semibold">
                                                                <svg class="h-4 w-4" fill="none" stroke="currentColor"
                                                                    viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                                        stroke-width="2"
                                                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z">
                                                                    </path>
                                                                </svg>
                                                                <span class="pipeline-step-duration"
                                                                    th:text="${step.duration != null} ? ${step.duration / 1000.0} + 's' : 'pending'">2.5s</span>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Progress Bar for Running Steps -->
                                                <div th:if="${step.status.name() == 'IN_PROGRESS'}" class="mt-4">
                                                    <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                                                        <div class="h-full bg-gradient-to-r from-blue-500 to-cyan-500 rounded-full animate-pulse"
                                                            style="width: 60%"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Animated Connection Line (except for last) -->
                                        <div th:if="${!iter.last}" class="flex justify-start pl-8 py-2">
                                            <div class="w-0.5 h-8 rounded-full transition-all duration-500"
                                                th:classappend="${step.status.name() == 'SUCCESS'} ? ' bg-gradient-to-b from-green-400 to-emerald-500' :
                                                             (${step.status.name() == 'FAILURE'} ? ' bg-gradient-to-b from-red-400 to-pink-500' :
                                                             (${step.status.name() == 'IN_PROGRESS'} ? ' bg-gradient-to-b from-blue-400 to-cyan-500 shadow-lg shadow-blue-500/50' : ' bg-gray-300'))">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div th:if="${build.steps == null || build.steps.empty}"
                            class="relative overflow-hidden rounded-2xl bg-gradient-to-br from-gray-50 to-gray-100 border border-gray-200 text-center py-20">
                            <div class="relative z-10">
                                <div
                                    class="w-24 h-24 mx-auto mb-4 rounded-full bg-gray-200 flex items-center justify-center">
                                    <svg class="h-12 w-12 text-gray-400" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4">
                                        </path>
                                    </svg>
                                </div>
                                <p class="text-xl font-semibold text-gray-600">No Pipeline Steps Found</p>
                                <p class="text-gray-500 mt-2">This build doesn't have any pipeline data available</p>
                            </div>
                        </div>
                    </section>

                    <!-- Overview Section -->
                    <section id="overview" class="build-section"
                        th:classappend="${section == 'overview'} ? ' active' : ''">
                        <div class="flex items-center justify-between mb-8">
                            <h2 class="text-3xl font-bold text-gray-900">Build Overview</h2>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <!-- Repository Information Card -->
                            <div
                                class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden hover:shadow-lg transition-shadow duration-200">
                                <div
                                    class="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 border-b border-gray-200">
                                    <div class="flex items-center gap-3">
                                        <div class="p-2 bg-blue-100 rounded-lg">
                                            <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24"
                                                stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                                            </svg>
                                        </div>
                                        <h3 class="text-lg font-bold text-gray-900">Repository Information</h3>
                                    </div>
                                </div>
                                <div class="p-6">
                                    <dl class="space-y-5">
                                        <div class="flex items-start gap-3">
                                            <svg class="h-5 w-5 text-gray-400 mt-0.5 flex-shrink-0" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                                            </svg>
                                            <div class="flex-1">
                                                <dt
                                                    class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">
                                                    Repository</dt>
                                                <dd class="text-sm font-mono font-semibold text-gray-900 bg-gray-50 px-3 py-2 rounded border border-gray-200"
                                                    th:text="${build.repositoryOwner + '/' + build.repositoryName}">
                                                </dd>
                                            </div>
                                        </div>
                                        <div class="flex items-start gap-3">
                                            <svg class="h-5 w-5 text-gray-400 mt-0.5 flex-shrink-0" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                                            </svg>
                                            <div class="flex-1">
                                                <dt
                                                    class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">
                                                    Branch</dt>
                                                <dd class="text-sm font-mono font-semibold text-gray-900 bg-gray-50 px-3 py-2 rounded border border-gray-200"
                                                    th:text="${build.branch}"></dd>
                                            </div>
                                        </div>
                                        <div class="flex items-start gap-3">
                                            <svg class="h-5 w-5 text-gray-400 mt-0.5 flex-shrink-0" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                                            </svg>
                                            <div class="flex-1">
                                                <dt
                                                    class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">
                                                    Commit SHA</dt>
                                                <dd class="text-xs font-mono font-bold text-gray-900 bg-gray-50 px-3 py-2 rounded border border-gray-200 break-all"
                                                    th:text="${build.commitSha}"></dd>
                                            </div>
                                        </div>
                                        <div class="flex items-start gap-3">
                                            <svg class="h-5 w-5 text-gray-400 mt-0.5 flex-shrink-0" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                                            </svg>
                                            <div class="flex-1">
                                                <dt
                                                    class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">
                                                    Commit Message</dt>
                                                <dd class="text-sm text-gray-900 bg-gray-50 px-3 py-2 rounded border border-gray-200"
                                                    th:text="${build.commitMessage}"></dd>
                                            </div>
                                        </div>
                                    </dl>
                                </div>
                            </div>

                            <!-- Execution Timeline Card -->
                            <div
                                class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden hover:shadow-lg transition-shadow duration-200">
                                <div
                                    class="bg-gradient-to-r from-green-50 to-emerald-50 px-6 py-4 border-b border-gray-200">
                                    <div class="flex items-center gap-3">
                                        <div class="p-2 bg-green-100 rounded-lg">
                                            <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24"
                                                stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                        </div>
                                        <h3 class="text-lg font-bold text-gray-900">Execution Timeline</h3>
                                    </div>
                                </div>
                                <div class="p-6">
                                    <dl class="space-y-5">
                                        <div class="flex items-start gap-3">
                                            <svg class="h-5 w-5 text-gray-400 mt-0.5 flex-shrink-0" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                            </svg>
                                            <div class="flex-1">
                                                <dt
                                                    class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">
                                                    Triggered By</dt>
                                                <dd class="text-sm font-semibold text-gray-900 bg-gray-50 px-3 py-2 rounded border border-gray-200"
                                                    th:text="${build.triggeredBy}"></dd>
                                            </div>
                                        </div>
                                        <div class="flex items-start gap-3">
                                            <svg class="h-5 w-5 text-gray-400 mt-0.5 flex-shrink-0" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                            <div class="flex-1">
                                                <dt
                                                    class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">
                                                    Started At</dt>
                                                <dd class="text-sm font-semibold text-gray-900 bg-gray-50 px-3 py-2 rounded border border-gray-200"
                                                    th:text="${#dates.format(build.startedAt, 'MMM dd, yyyy HH:mm:ss')}">
                                                </dd>
                                            </div>
                                        </div>
                                        <div class="flex items-start gap-3" th:if="${build.completedAt != null}">
                                            <svg class="h-5 w-5 text-gray-400 mt-0.5 flex-shrink-0" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            <div class="flex-1">
                                                <dt
                                                    class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">
                                                    Completed At</dt>
                                                <dd class="text-sm font-semibold text-gray-900 bg-gray-50 px-3 py-2 rounded border border-gray-200"
                                                    th:text="${#dates.format(build.completedAt, 'MMM dd, yyyy HH:mm:ss')}">
                                                </dd>
                                            </div>
                                        </div>
                                        <div th:if="${build.duration != null}">
                                            <dt class="text-sm font-medium text-gray-500">Total Duration</dt>
                                            <dd class="mt-1 text-sm text-gray-900 font-semibold text-blue-600"
                                                th:text="${build.duration / 1000.0} + ' seconds'"></dd>
                                        </div>
                                    </dl>
                                </div>
                            </div>
                    </section>

                    <!-- Build Steps Section -->
                    <section id="steps" class="build-section" th:classappend="${section == 'steps'} ? ' active' : ''">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">Build Steps</h2>

                        <div th:if="${build.steps != null && !build.steps.empty}">
                            <div class="space-y-3">
                                <div th:each="step, iterStat : ${build.steps}"
                                    class="bg-white rounded-lg border border-gray-200 overflow-hidden hover:shadow-md transition-shadow"
                                    th:attr="data-step-index=${iterStat.index}">
                                    <div class="p-4 flex items-center justify-between border-b border-gray-100">
                                        <div class="flex items-center gap-3">
                                            <span
                                                class="text-lg font-semibold text-gray-900 w-8 h-8 flex items-center justify-center rounded-full bg-gray-100"
                                                th:text="${iterStat.count}"></span>
                                            <span class="text-lg font-semibold text-gray-900"
                                                th:text="${step.name}"></span>
                                            <span
                                                class="step-status-badge px-2.5 py-0.5 text-xs font-semibold rounded-full"
                                                th:text="${step.status.name() == 'SUCCESS' ? '✓ Success' : (step.status.name() == 'FAILURE' ? '✗ Failed' : (step.status.name() == 'IN_PROGRESS' ? '⟳ In Progress' : (step.status.name() == 'PENDING' ? '○ Pending' : '⊘ Skipped')))}"
                                                th:classappend="${step.status.name() == 'SUCCESS' ? ' bg-green-100 text-green-800' :
                                                                                                 (step.status.name() == 'FAILURE' ? ' bg-red-100 text-red-800' :
                                                                                                 (step.status.name() == 'IN_PROGRESS' ? ' bg-blue-100 text-blue-800' :
                                                                                                 (step.status.name() == 'PENDING' ? ' bg-yellow-100 text-yellow-800' : ' bg-gray-100 text-gray-800')))}">
                                            </span>
                                        </div>
                                        <span class="text-sm font-medium text-gray-500" th:if="${step.duration != null}"
                                            th:text="${step.duration / 1000.0} + 's'"></span>
                                    </div>

                                    <!-- Step Output -->
                                    <div th:if="${step.output != null && !step.output.isEmpty()}"
                                        class="p-4 bg-gray-50">
                                        <div
                                            class="bg-gray-900 text-gray-100 p-4 rounded-lg text-xs font-mono overflow-x-auto max-h-64 overflow-y-auto border border-gray-700">
                                            <pre th:text="${step.output}" class="whitespace-pre-wrap text-gray-100"
                                                th:attr="data-step-output-index=${iterStat.index}"></pre>
                                        </div>
                                    </div>

                                    <!-- Error Message -->
                                    <div th:if="${step.errorMessage != null && !step.errorMessage.isEmpty()}"
                                        class="p-4 bg-red-50 border-t border-red-100">
                                        <div
                                            class="bg-red-50 border border-red-200 text-red-800 p-3 rounded-lg text-sm">
                                            <strong class="block mb-1">Error:</strong> <span
                                                th:text="${step.errorMessage}"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div th:if="${build.steps == null || build.steps.empty}"
                            class="bg-white rounded-lg border border-gray-200 text-center py-12 text-gray-500">
                            <p class="text-lg">No build steps recorded</p>
                        </div>
                    </section>

                    <!-- Full Logs Section -->
                    <section id="logs" class="build-section" th:classappend="${section == 'logs'} ? ' active' : ''">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">Complete Build Log</h2>
                        <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                            <div
                                class="bg-gray-900 text-gray-100 p-6 font-mono text-sm overflow-x-auto max-h-[600px] overflow-y-auto">
                                <pre id="build-log" th:text="${build.buildLog}"
                                    class="whitespace-pre-wrap text-gray-100">No logs available</pre>
                            </div>
                        </div>
                    </section>

                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        const buildId = [[${ build.id }]];
        const pollIntervalMs = 1000;

        let statusBadges = [];
        const bodyEl = document.body;
        let buildLogEl = null;

        const terminalClasses = {
            SUCCESS: 'bg-green-100 text-green-800',
            FAILURE: 'bg-red-100 text-red-800',
            IN_PROGRESS: 'bg-blue-100 text-blue-800',
            PENDING: 'bg-gray-100 text-gray-800',
            SKIPPED: 'bg-gray-100 text-gray-800'
        };

        const bubbleClasses = {
            SUCCESS: 'border-green-500 bg-green-500',
            FAILURE: 'border-red-500 bg-red-500',
            IN_PROGRESS: 'border-blue-500 bg-blue-500 animate-pulse',
            PENDING: 'border-gray-300 bg-white',
            SKIPPED: 'border-gray-300 bg-gray-100' // Visual distinction for skipped
        };

        const connectorClasses = {
            SUCCESS: 'bg-gray-200', // Completed steps connect with gray or green? Usually gray is fine, or green if we want a "green path". Let's stick to gray unless it's the active path.
            FAILURE: 'bg-red-200',
            IN_PROGRESS: 'bg-blue-200',
            PENDING: 'bg-gray-200',
            SKIPPED: 'bg-gray-200'
        };

        function badgeText(status) {
            switch (status) {
                case 'SUCCESS': return '✓ Success';
                case 'FAILURE': return '✗ Failed';
                case 'IN_PROGRESS': return '⟳ In Progress';
                case 'PENDING': return '○ Pending';
                case 'SKIPPED': return '⊘ Skipped';
                default: return status;
            }
        }

        function clearClasses(el, classesMap) {
            // Collect all possible classes from the map values
            const allPossibleClasses = new Set();
            Object.values(classesMap).forEach(clsStr => {
                clsStr.split(' ').forEach(c => allPossibleClasses.add(c));
            });
            el.classList.remove(...allPossibleClasses);
        }

        function getStatusName(s) {
            if (!s) return '';
            if (typeof s === 'string') return s;
            if (typeof s === 'object' && s.name) return s.name;
            return String(s);
        }

        function updateStatus(status) {
            const statusName = getStatusName(status);
            statusBadges.forEach((badge) => {
                // simple clear for badges as they use terminalClasses
                badge.className = 'build-status-badge inline-block px-2.5 py-1 text-xs font-semibold rounded-full ' + (terminalClasses[statusName] || 'bg-gray-100 text-gray-800');
                badge.textContent = badgeText(statusName);
            });
            bodyEl.setAttribute('data-build-status', statusName);
        }


        function updatePipeline(steps) {
            if (!steps) return;
            steps.forEach((step, idx) => {
                const stepCard = document.querySelector(`[data-pipeline-step-index="${idx}"]`);
                if (!stepCard) return;

                const status = getStatusName(step.status);

                // Update step status badge
                const statusBadge = stepCard.querySelector('.pipeline-step-status');
                if (statusBadge) {
                    const statusText = status === 'SUCCESS' ? 'Success' :
                        (status === 'FAILURE' ? 'Failed' :
                            (status === 'IN_PROGRESS' ? 'Running' : 'Pending'));
                    statusBadge.textContent = statusText;
                }

                // Update Duration
                const durEl = stepCard.querySelector('.pipeline-step-duration');
                if (durEl) {
                    durEl.textContent = step.duration != null ?
                        (step.duration / 1000).toFixed(1).replace(/\.0$/, '') + 's' :
                        (status === 'PENDING' ? 'pending' : (status === 'IN_PROGRESS' ? 'running' : '-'));
                }

                // Update card classes for dynamic styling (border colors, animations)
                const card = stepCard.querySelector('.relative.flex.items-start');
                if (card) {
                    // Remove existing border classes
                    card.classList.remove('border-l-green-500', 'border-l-red-500', 'border-l-blue-500', 'border-l-gray-300', 'animate-pulse');

                    // Add appropriate classes based on status
                    if (status === 'SUCCESS') {
                        card.classList.add('border-l-green-500');
                    } else if (status === 'FAILURE') {
                        card.classList.add('border-l-red-500');
                    } else if (status === 'IN_PROGRESS') {
                        card.classList.add('border-l-blue-500', 'animate-pulse');
                    } else {
                        card.classList.add('border-l-gray-300');
                    }
                }
            });
        }

        function updateSummary(steps) {
            if (!steps) return;

            const counts = { SUCCESS: 0, FAILURE: 0, IN_PROGRESS: 0, PENDING: 0 };
            steps.forEach(s => {
                const st = getStatusName(s.status);
                if (counts[st] !== undefined) counts[st]++;
            });

            // Update premium dashboard cards
            const successEl = document.getElementById('summary-success-count');
            const failedEl = document.getElementById('summary-failed-count');
            const runningEl = document.getElementById('summary-running-count');
            const pendingEl = document.getElementById('summary-pending-count');

            if (successEl) successEl.textContent = counts.SUCCESS;
            if (failedEl) failedEl.textContent = counts.FAILURE;
            if (runningEl) runningEl.textContent = counts.IN_PROGRESS;
            if (pendingEl) pendingEl.textContent = counts.PENDING;
        }

        function updateSteps(steps) {
            if (!steps) return;
            steps.forEach((step, idx) => {
                // Update Card List
                const card = document.querySelector(`[data-step-index="${idx}"]`);
                if (card) {
                    constbadge = card.querySelector('.step-status-badge');
                    if (badge) {
                        const s = getStatusName(step.status);
                        badge.className = 'step-status-badge px-2.5 py-0.5 text-xs font-semibold rounded-full ' + (terminalClasses[s] || 'bg-gray-100 text-gray-800');
                        badge.textContent = badgeText(s);
                    }
                    // Update output ... (existing logic)
                    const outputPre = card.querySelector(`[data-step-output-index="${idx}"]`);
                    if (outputPre && step.output != null) {
                        outputPre.textContent = step.output;
                    }
                    const durationEl = card.querySelector('.text-sm.font-medium.text-gray-500');
                    if (durationEl && step.duration != null) {
                        durationEl.textContent = (step.duration / 1000).toFixed(1).replace(/\.0$/, '') + 's';
                    }
                }

                // Update Table Row List (Compact view)
                const row = document.querySelector(`[data-step-row-index="${idx}"]`);
                if (row) {
                    const statusIcon = row.querySelector('.w-7.h-7');
                    const s = getStatusName(step.status);
                    if (statusIcon) {
                        // Simplify update
                        statusIcon.className = `w-7 h-7 rounded-full flex items-center justify-center font-semibold ${terminalClasses[s] || 'bg-gray-100 text-gray-800'}`;
                    }
                    const statusTextEl = row.querySelector('.w-32.text-right span');
                    if (statusTextEl) {
                        statusTextEl.className = `px-2 py-1 text-xs font-semibold rounded-full ${terminalClasses[s] || 'bg-gray-100 text-gray-800'}`;
                        statusTextEl.textContent = s.charAt(0) + s.slice(1).toLowerCase().replace('_', ' ');
                    }
                    const durEl = row.querySelector('.w-24.text-right');
                    if (durEl) {
                        durEl.textContent = step.duration != null ? (step.duration / 1000).toFixed(1).replace(/\.0$/, '') + 's' : '-';
                    }
                }
            });
        }

        function updateLog(logText) {
            if (buildLogEl && logText != null) {
                const atBottom = Math.abs((buildLogEl.parentElement.scrollTop + buildLogEl.parentElement.clientHeight) - buildLogEl.parentElement.scrollHeight) < 10;
                buildLogEl.textContent = logText;
                if (atBottom) {
                    buildLogEl.parentElement.scrollTop = buildLogEl.parentElement.scrollHeight;
                }
            }
        }

        async function poll() {
            try {
                const res = await fetch(`/builds/${buildId}/status`, { headers: { 'Accept': 'application/json' } });
                if (!res.ok) return;
                const build = await res.json();
                onBuildUpdate(build);
            } catch (err) {
                console.error('Polling error', err);
            }
        }

        let pollHandle = null;
        function startPolling() {
            if (!buildLogEl) buildLogEl = document.getElementById('build-log');
            const current = bodyEl.getAttribute('data-build-status');
            poll();
            if (current === 'IN_PROGRESS' || current === 'PENDING') {
                if (!pollHandle) pollHandle = setInterval(poll, pollIntervalMs);
            }
        }

        function onBuildUpdate(build) {
            if (!build) return;
            updateStatus(build.status);
            updateSteps(build.steps || []);
            updatePipeline(build.steps || []);
            updateSummary(build.steps || []);
            updateLog(build.buildLog);

            if (build.status !== 'IN_PROGRESS' && build.status !== 'PENDING') {
                stopPolling();
                closeSse();
            }
        }

        let eventSource = null;
        function startSse() {
            statusBadges = Array.from(document.querySelectorAll('.build-status-badge'));
            if (!buildLogEl) buildLogEl = document.getElementById('build-log');
            if (!window.EventSource) {
                startPolling();
                return;
            }
            // Close any existing
            closeSse();

            eventSource = new EventSource(`/builds/${buildId}/events`);
            eventSource.onmessage = (event) => {
                try {
                    const build = JSON.parse(event.data);
                    onBuildUpdate(build);
                } catch (e) {
                    console.error('SSE parse error', e);
                }
            };
            eventSource.onerror = () => {
                // If connection drops, fallback to polling
                closeSse();
                startPolling();
            };
        }

        function closeSse() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        }

        function stopPolling() {
            if (pollHandle) {
                clearInterval(pollHandle);
                pollHandle = null;
            }
        }

        document.addEventListener('DOMContentLoaded', startSse);
    </script>

</body>

</html>