<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:text="'Pipeline #' + ${build.id}">Pipeline View</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* Clean monochrome scrollbars */
        .log-scroll::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .log-scroll::-webkit-scrollbar-track {
            background: #000;
        }

        .log-scroll::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        .log-scroll::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Pipeline step spacing to prevent overlap */
        .pipeline-step-wrapper {
            min-width: 200px;
            padding: 0 20px;
        }

        /* Unique vertical card design */
        .step-vertical-card {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transform: rotate(180deg);
            white-space: nowrap;
        }
    </style>
</head>

<body class="bg-gray-50 h-screen flex flex-col overflow-hidden">

    <!-- Clean Header -->
    <header class="bg-white border-b-4 flex-none shadow-sm" id="main-header" th:classappend="${build.status.name() == 'SUCCESS' ? 'border-green-500' : 
                          (build.status.name() == 'FAILURE' ? 'border-red-500' : 
                          (build.status.name() == 'IN_PROGRESS' ? 'border-blue-500' : 
                          (build.status.name() == 'CANCELLED' ? 'border-orange-500' : 'border-gray-300')))}">
        <div class="px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-6">
                <a th:href="@{/builds}" class="text-gray-600 hover:text-black transition">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                </a>
                <div class="flex items-center gap-4">
                    <!-- Build Navigation -->
                    <div class="flex items-center gap-2">
                        <button onclick="navigateToPreviousBuild()"
                            class="p-1 text-gray-400 hover:text-gray-600 transition" title="Previous Build">
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <h1 class="text-lg font-semibold">
                            <span class="text-gray-500" th:text="${build.repositoryName}"></span>
                            <span class="text-gray-400 mx-2">/</span>
                            <span th:text="'Build #' + ${build.id}"></span>
                        </h1>
                        <button onclick="navigateToNextBuild()" class="p-1 text-gray-400 hover:text-gray-600 transition"
                            title="Next Build">
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                    <span id="header-status-badge" class="px-3 py-1 text-xs font-semibold uppercase border-2 rounded"
                        th:classappend="${build.status.name() == 'SUCCESS' ? 'border-green-500 text-green-600 bg-green-50' : 
                                         (build.status.name() == 'FAILURE' ? 'border-red-500 text-red-600 bg-red-50' : 
                                         (build.status.name() == 'IN_PROGRESS' ? 'border-blue-500 text-blue-600 bg-blue-50' : 
                                         (build.status.name() == 'CANCELLED' ? 'border-orange-500 text-orange-600 bg-orange-50' : 'border-gray-300 text-gray-600 bg-gray-50')))}"
                        th:text="${build.status}">PENDING</span>
                    <!-- Cancel Button (shown only when build is in progress) -->
                    <button id="cancel-build-btn" onclick="cancelBuild()"
                        class="px-3 py-1 text-xs font-semibold uppercase border-2 rounded border-red-500 text-red-600 bg-red-50 hover:bg-red-100 transition"
                        th:classappend="${build.status.name() != 'IN_PROGRESS' ? 'hidden' : ''}">
                        <span class="flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                            Cancel
                        </span>
                    </button>
                </div>
            </div>
            <div class="flex items-center gap-6 text-sm text-gray-600">
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                    </svg>
                    <span th:text="${build.branch}"></span>
                </div>
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                    </svg>
                    <span class="font-mono" th:text="${#strings.substring(build.commitSha, 0, 7)}"></span>
                </div>
                <div class="flex items-center gap-2 font-semibold">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span id="header-duration"
                        th:text="${build.duration != null ? (build.duration/1000.0 + 's') : '-'}">-</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Horizontal Pipeline - Improved Design -->
    <div class="bg-white border-b border-gray-200 flex-none overflow-x-auto py-10">
        <div class="min-w-max px-12 flex items-center justify-center gap-0" id="pipeline-container">

            <th:block th:each="step, iter : ${build.steps}">
                <!-- Step Card -->
                <div class="flex flex-col items-center cursor-pointer group transition-all hover:scale-105"
                    th:attr="data-step-index=${iter.index}, onclick='selectStep(' + ${iter.index} + ')'">

                    <!-- Step Circle with Icon -->
                    <div class="relative">
                        <div class="w-12 h-12 rounded-full border-3 flex items-center justify-center transition-all shadow-md bg-white"
                            th:classappend="${step.status.name() == 'SUCCESS'} ? 'border-green-500' : 
                                           (${step.status.name() == 'FAILURE'} ? 'border-red-500' : 
                                           (${step.status.name() == 'IN_PROGRESS'} ? 'border-blue-500 shadow-lg' : 'border-gray-300'))">

                            <div class="text-center"
                                th:classappend="${step.status.name() == 'SUCCESS'} ? 'text-green-600' : 
                                               (${step.status.name() == 'FAILURE'} ? 'text-red-600' : 
                                               (${step.status.name() == 'IN_PROGRESS'} ? 'text-blue-600' : 'text-gray-400'))">
                                <svg th:if="${step.status.name() == 'SUCCESS'}" class="w-6 h-6" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                        clip-rule="evenodd" />
                                </svg>
                                <svg th:if="${step.status.name() == 'FAILURE'}" class="w-6 h-6" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                        clip-rule="evenodd" />
                                </svg>
                                <div th:if="${step.status.name() == 'IN_PROGRESS'}" class="relative">
                                    <svg class="w-6 h-6 animate-spin" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                            stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor"
                                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                        </path>
                                    </svg>
                                </div>
                                <span th:if="${step.status.name() == 'PENDING'}" class="text-base font-bold"
                                    th:text="${iter.count}"></span>
                            </div>
                        </div>

                        <!-- Step Number Badge -->
                        <div
                            class="absolute -top-1 -right-1 w-5 h-5 bg-gray-800 text-white rounded-full flex items-center justify-center text-xs font-bold">
                            <span th:text="${iter.count}"></span>
                        </div>
                    </div>

                    <!-- Step Name & Duration -->
                    <div class="mt-3 text-center" style="width: 120px;">
                        <p class="text-sm font-semibold text-gray-800 truncate px-2" th:text="${step.name}">Step</p>
                        <p class="text-xs text-gray-500 mt-1" th:id="'duration-' + ${iter.index}"
                            th:text="${step.duration != null ? (step.duration/1000.0 + 's') : ''}"></p>
                    </div>
                </div>

                <!-- Connector Line -->
                <div th:if="${!iter.last}" class="flex items-center" style="margin-top: -50px;">
                    <div class="h-1 w-10 transition-colors" th:classappend="${step.status.name() == 'SUCCESS'} ? 'bg-green-500' : 
                                       (${step.status.name() == 'FAILURE'} ? 'bg-red-500' : 
                                       (${step.status.name() == 'IN_PROGRESS'} ? 'bg-blue-500' : 'bg-gray-300'))">
                    </div>
                </div>
            </th:block>

        </div>
    </div>

    <!-- Main Content: Steps List & Logs -->
    <div class="flex-1 flex overflow-hidden">

        <!-- Steps Sidebar -->
        <div class="w-80 bg-white border-r border-gray-200 flex flex-col">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                <h2 class="font-semibold text-gray-800">Build Steps</h2>
                <span class="text-xs font-semibold px-2 py-1 bg-gray-200 text-gray-600 rounded"
                    th:text="${build.steps.size()}"></span>
            </div>
            <div class="overflow-y-auto flex-1 p-3 space-y-2" id="steps-list">
                <div th:each="step, iter : ${build.steps}"
                    class="step-card p-3 border-2 border-gray-200 rounded cursor-pointer hover:border-gray-400 transition-all"
                    th:attr="onclick='selectStep(' + ${iter.index} + ')', id='card-' + ${iter.index}">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-semibold text-gray-800" th:text="${step.name}"></span>
                        <div class="step-card-status text-xl">
                            <span th:if="${step.status.name() == 'SUCCESS'}" class="text-green-600">‚úì</span>
                            <span th:if="${step.status.name() == 'FAILURE'}" class="text-red-600">‚úó</span>
                            <span th:if="${step.status.name() == 'IN_PROGRESS'}" class="text-blue-600">‚ü≥</span>
                            <span th:if="${step.status.name() == 'PENDING'}" class="text-gray-400">‚óã</span>
                        </div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500">
                        <span th:text="${step.status}"></span>
                        <span class="font-mono"
                            th:text="${step.duration != null ? (step.duration/1000.0 + 's') : '-'}"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Panel - Lighter Design -->
        <div class="flex-1 bg-gray-900 flex flex-col">
            <div class="flex items-center justify-between px-4 py-3 bg-gray-800 border-b border-gray-700">
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span id="log-filename" class="text-sm font-mono text-gray-300">build.log</span>
                </div>
                <a th:href="@{|/builds/${build.id}/logs|}" target="_blank"
                    class="text-xs text-gray-400 hover:text-white transition flex items-center gap-1">
                    <span>View Raw</span>
                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                </a>
            </div>
            <div class="flex-1 overflow-auto p-4 log-scroll">
                <pre id="active-log"
                    class="font-mono text-sm text-gray-300 whitespace-pre-wrap leading-relaxed">No logs selected...</pre>
            </div>
            <div id="step-error-banner" class="hidden bg-red-900 text-white p-4 border-t-2 border-red-700">
                <div class="flex items-center gap-2 mb-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="text-sm font-bold">Step Failed</span>
                </div>
                <div id="step-error-msg" class="text-sm font-mono opacity-90 pl-7"></div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        const buildId = /*[[${build.id}]]*/ 1;
        let currentBuild = /*[[${build}]]*/ {};
        let currentStepIndex = 0;

        document.addEventListener('DOMContentLoaded', () => {
            selectStartStep();
            startPolling();
        });

        function selectStartStep() {
            if (!currentBuild.steps || currentBuild.steps.length === 0) {
                showFullBuildLog();
                return;
            }
            let targetIdx = 0;
            const running = currentBuild.steps.findIndex(s => s.status === 'IN_PROGRESS');
            if (running !== -1) targetIdx = running;
            else {
                const failed = currentBuild.steps.findIndex(s => s.status === 'FAILURE');
                if (failed !== -1) targetIdx = failed;
            }
            selectStep(targetIdx);
        }

        function selectStep(index) {
            currentStepIndex = index;

            document.querySelectorAll('.step-card').forEach((el, i) => {
                if (i === index) {
                    el.classList.add('border-blue-500', 'bg-blue-50', 'shadow-md');
                    el.classList.remove('border-gray-200');
                    el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    el.classList.remove('border-blue-500', 'bg-blue-50', 'shadow-md');
                    el.classList.add('border-gray-200');
                }
            });

            const step = currentBuild.steps[index];
            const logPre = document.getElementById('active-log');
            const fname = document.getElementById('log-filename');

            if (step) {
                fname.textContent = step.name + '.log';
                logPre.textContent = step.output || 'No output recorded for this step.';

                const errBanner = document.getElementById('step-error-banner');
                if (step.status === 'FAILURE' && step.errorMessage) {
                    errBanner.classList.remove('hidden');
                    document.getElementById('step-error-msg').textContent = step.errorMessage;
                } else {
                    errBanner.classList.add('hidden');
                }
            }
        }

        function showFullBuildLog() {
            const logPre = document.getElementById('active-log');
            logPre.textContent = currentBuild.buildLog || "Waiting for logs...";
            document.getElementById('log-filename').textContent = "build.log";
        }

        async function updateBuild(data) {
            console.log('Received build update:', data.status, 'Steps:', data.steps?.length);

            // Check for new steps and render them if necessary
            const pipelineContainer = document.getElementById('pipeline-container');
            // Count step cards (direct children with data-step-index)
            const existingSteps = pipelineContainer.querySelectorAll('div[data-step-index]').length;

            if (data.steps && data.steps.length > existingSteps) {
                console.log('Found new steps! Existing:', existingSteps, 'New total:', data.steps.length);
                for (let i = existingSteps; i < data.steps.length; i++) {
                    renderNewPipelineStep(data.steps[i], i);
                    renderNewSidebarStep(data.steps[i], i);
                }
            }

            currentBuild = data;

            const header = document.getElementById('main-header');
            const badge = document.getElementById('header-status-badge');
            badge.textContent = data.status;

            let borderClass = 'border-gray-300';
            let badgeClass = 'border-gray-300 text-gray-600 bg-gray-50';
            if (data.status === 'SUCCESS') {
                borderClass = 'border-green-500';
                badgeClass = 'border-green-500 text-green-600 bg-green-50';
            } else if (data.status === 'FAILURE') {
                borderClass = 'border-red-500';
                badgeClass = 'border-red-500 text-red-600 bg-red-50';
            } else if (data.status === 'IN_PROGRESS') {
                borderClass = 'border-blue-500';
                badgeClass = 'border-blue-500 text-blue-600 bg-blue-50';
            } else if (data.status === 'CANCELLED') {
                borderClass = 'border-orange-500';
                badgeClass = 'border-orange-500 text-orange-600 bg-orange-50';
            }

            header.className = 'bg-white border-b-4 flex-none shadow-sm ' + borderClass;
            badge.className = 'px-3 py-1 text-xs font-semibold uppercase border-2 rounded ' + badgeClass;

            // Show/hide cancel button based on status
            const cancelBtn = document.getElementById('cancel-build-btn');
            if (cancelBtn) {
                if (data.status === 'IN_PROGRESS') {
                    cancelBtn.classList.remove('hidden');
                } else {
                    cancelBtn.classList.add('hidden');
                }
            }

            document.getElementById('header-duration').textContent = data.duration ? (data.duration / 1000).toFixed(1) + 's' : '-';

            // Update step durations
            data.steps.forEach((step, idx) => {
                const durEl = document.getElementById('duration-' + idx);
                if (durEl) durEl.textContent = step.duration ? (step.duration / 1000).toFixed(1) + 's' : '';
            });

            // Update pipeline circles
            updatePipelineCircles(data.steps);

            if (currentStepIndex !== -1 && currentBuild.steps[currentStepIndex]) {
                const currentStep = currentBuild.steps[currentStepIndex];
                const logPre = document.getElementById('active-log');
                if (logPre.textContent !== currentStep.output) {
                    const isScrolledToBottom = logPre.parentElement.scrollHeight - logPre.parentElement.scrollTop === logPre.parentElement.clientHeight;
                    logPre.textContent = currentStep.output || "Running...";
                    if (isScrolledToBottom) logPre.parentElement.scrollTop = logPre.parentElement.scrollHeight;
                }
            }

            updateSidebarList(data.steps);

            // Stop polling when build is complete (case-insensitive check)
            const statusUpper = (data.status || '').toUpperCase();
            if (statusUpper === 'SUCCESS' || statusUpper === 'FAILURE' || statusUpper === 'CANCELLED') {
                console.log('Build complete, stopping polling. Status:', data.status);
                if (pollHandle) {
                    clearInterval(pollHandle);
                    pollHandle = null;
                }
                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
            }
        }

        function updatePipelineCircles(steps) {
            steps.forEach((step, idx) => {
                const stepWrapper = document.querySelector('[data-step-index="' + idx + '"]');
                if (!stepWrapper) return;

                const circle = stepWrapper.querySelector('.w-12.h-12');
                const iconContainer = circle?.querySelector('.text-center');

                if (!circle || !iconContainer) return;

                // Update circle border color
                circle.className = 'w-12 h-12 rounded-full border-3 flex items-center justify-center transition-all shadow-md bg-white';
                if (step.status === 'SUCCESS') {
                    circle.classList.add('border-green-500');
                } else if (step.status === 'FAILURE') {
                    circle.classList.add('border-red-500');
                } else if (step.status === 'IN_PROGRESS') {
                    circle.classList.add('border-blue-500', 'shadow-lg');
                } else {
                    circle.classList.add('border-gray-300');
                }

                // Update icon color
                iconContainer.className = 'text-center';
                if (step.status === 'SUCCESS') {
                    iconContainer.classList.add('text-green-600');
                } else if (step.status === 'FAILURE') {
                    iconContainer.classList.add('text-red-600');
                } else if (step.status === 'IN_PROGRESS') {
                    iconContainer.classList.add('text-blue-600');
                } else {
                    iconContainer.classList.add('text-gray-400');
                }

                // Update icon based on status
                let iconHTML = '';
                if (step.status === 'SUCCESS') {
                    iconHTML = '<svg class="w-6 h-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>';
                } else if (step.status === 'FAILURE') {
                    iconHTML = '<svg class="w-6 h-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>';
                } else if (step.status === 'IN_PROGRESS') {
                    iconHTML = '<div class="relative"><svg class="w-6 h-6 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';
                } else {
                    iconHTML = '<span class="text-base font-bold">' + (idx + 1) + '</span>';
                }
                iconContainer.innerHTML = iconHTML;
            });
        }

        function updateSidebarList(steps) {
            steps.forEach((step, idx) => {
                const card = document.getElementById('card-' + idx);
                if (card) {
                    const statusDiv = card.querySelector('.step-card-status');
                    let icon = '‚óã';
                    if (step.status === 'SUCCESS') icon = '<span class="text-green-600">‚úì</span>';
                    else if (step.status === 'FAILURE') icon = '<span class="text-red-600">‚úó</span>';
                    else if (step.status === 'IN_PROGRESS') icon = '<span class="text-blue-600">‚ü≥</span>';
                    statusDiv.innerHTML = icon;
                }
            });
        }

        let pollHandle = null;
        let eventSource = null;

        function renderNewPipelineStep(step, index) {
            const container = document.getElementById('pipeline-container');

            // Add connector if not the first step
            if (index > 0) {
                const connector = document.createElement('div');
                connector.className = 'flex items-center';
                connector.style.marginTop = '-50px';
                connector.innerHTML = '<div class="h-1 w-10 transition-colors bg-gray-300"></div>';
                container.appendChild(connector);
            }

            // basic step HTML
            const stepDiv = document.createElement('div');
            stepDiv.className = 'flex flex-col items-center cursor-pointer group transition-all hover:scale-105';
            stepDiv.dataset.stepIndex = index;
            stepDiv.onclick = () => selectStep(index);

            stepDiv.innerHTML = `
                <div class="relative">
                    <div class="w-12 h-12 rounded-full border-3 flex items-center justify-center transition-all shadow-md bg-white border-gray-300">
                        <div class="text-center text-gray-400">
                             <span class="text-base font-bold">${index + 1}</span>
                        </div>
                    </div>
                    <div class="absolute -top-1 -right-1 w-5 h-5 bg-gray-800 text-white rounded-full flex items-center justify-center text-xs font-bold">
                        <span>${index + 1}</span>
                    </div>
                </div>
                <div class="mt-3 text-center" style="width: 120px;">
                    <p class="text-sm font-semibold text-gray-800 truncate px-2">${step.name}</p>
                    <p class="text-xs text-gray-500 mt-1" id="duration-${index}"></p>
                </div>
            `;

            container.appendChild(stepDiv);
        }

        function renderNewSidebarStep(step, index) {
            const list = document.getElementById('steps-list');

            const card = document.createElement('div');
            card.className = 'step-card p-3 border-2 border-gray-200 rounded cursor-pointer hover:border-gray-400 transition-all';
            card.onclick = () => selectStep(index);
            card.id = 'card-' + index;

            card.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-semibold text-gray-800">${step.name}</span>
                    <div class="step-card-status text-xl">
                        <span class="text-gray-400">‚óã</span>
                    </div>
                </div>
                <div class="flex justify-between text-xs text-gray-500">
                    <span>${step.status || 'PENDING'}</span>
                    <span class="font-mono">-</span>
                </div>
            `;

            list.appendChild(card);
        }

        function startPolling() {
            // Check if build is already complete
            const initialStatus = (currentBuild.status || '').toUpperCase();
            if (initialStatus === 'SUCCESS' || initialStatus === 'FAILURE') {
                console.log('Build already complete, skipping polling. Status:', currentBuild.status);
                return;
            }

            console.log('Starting real-time updates for build', buildId);

            if (window.EventSource) {
                try {
                    const sseUrl = '/builds/' + buildId + '/events';
                    console.log('Connecting to SSE:', sseUrl);
                    eventSource = new EventSource(sseUrl);

                    eventSource.onopen = () => {
                        console.log('‚úÖ SSE connection opened successfully');
                    };

                    eventSource.onmessage = (e) => {
                        console.log('üì® SSE message received, data length:', e.data?.length);

                        // Ignore empty messages, comments, or separators
                        if (!e.data || e.data.trim() === '' || e.data.trim() === '---' || e.data.startsWith(':')) {
                            console.log('Ignoring SSE comment/separator:', e.data);
                            return;
                        }

                        try {
                            const data = JSON.parse(e.data);
                            console.log('‚úÖ Parsed SSE data successfully, status:', data.status);
                            updateBuild(data);
                        } catch (parseError) {
                            console.error('‚ùå Failed to parse SSE data:', parseError);
                            console.error('Raw data:', e.data?.substring(0, 500));
                        }
                    };

                    eventSource.onerror = (error) => {
                        console.error('‚ùå SSE connection error:', error);
                        console.log('SSE readyState:', eventSource?.readyState);
                        if (eventSource) {
                            eventSource.close();
                            eventSource = null;
                        }
                        console.log('Falling back to polling...');
                        fallbackPoll();
                    };
                } catch (error) {
                    console.error('‚ùå Failed to create SSE connection:', error);
                    fallbackPoll();
                }
            } else {
                console.log('SSE not supported, using polling');
                fallbackPoll();
            }
        }

        function fallbackPoll() {
            if (pollHandle) return;

            console.log('üìä Starting fallback polling every 1 second');
            pollHandle = setInterval(async () => {
                try {
                    const url = '/builds/' + buildId + '/status';
                    const res = await fetch(url);
                    console.log('Polling response status:', res.status, 'Content-Type:', res.headers.get('content-type'));

                    if (res.ok) {
                        const contentType = res.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const text = await res.text();
                            console.log('Response text preview:', text.substring(0, 100));
                            try {
                                const data = JSON.parse(text);
                                console.log('‚úÖ Polling update received');
                                updateBuild(data);
                            } catch (parseError) {
                                console.error('‚ùå JSON parse error:', parseError.message);
                                console.error('Full response (first 500 chars):', text.substring(0, 500));
                            }
                        } else {
                            const text = await res.text();
                            console.error('‚ùå Expected JSON but got:', contentType);
                            console.error('Response preview:', text.substring(0, 300));
                            // Stop polling if we're getting HTML
                            if (text.includes('<!DOCTYPE') || text.includes('<html')) {
                                console.error('Received HTML page instead of JSON. Stopping polling.');
                                clearInterval(pollHandle);
                                pollHandle = null;
                            }
                        }
                    } else {
                        console.error('Polling failed with status:', res.status);
                        if (res.status === 401 || res.status === 403) {
                            console.error('Authentication required. Stopping polling.');
                            clearInterval(pollHandle);
                            pollHandle = null;
                        }
                    }
                } catch (e) {
                    console.error('Polling error:', e.message);
                }
            }, 1000);
        }

        function navigateToPreviousBuild() {
            const prevId = buildId - 1;
            if (prevId > 0) {
                window.location.href = '/builds/' + prevId + '/pipeline';
            }
        }

        function navigateToNextBuild() {
            const nextId = buildId + 1;
            window.location.href = '/builds/' + nextId + '/pipeline';
        }

        function copyLink() {
            navigator.clipboard.writeText(window.location.href);
            alert("Link copied!");
        }

        async function cancelBuild() {
            if (!confirm('Are you sure you want to cancel this build?')) {
                return;
            }

            const cancelBtn = document.getElementById('cancel-build-btn');
            if (cancelBtn) {
                cancelBtn.disabled = true;
                cancelBtn.innerHTML = '<span class="flex items-center gap-1"><svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Cancelling...</span>';
            }

            try {
                const response = await fetch('/builds/' + buildId + '/cancel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                console.log('Cancel response:', result);

                if (result.success) {
                    console.log('Build cancelled successfully');
                    // The polling will pick up the status change
                } else {
                    alert('Failed to cancel build: ' + (result.message || result.error || 'Unknown error'));
                    if (cancelBtn) {
                        cancelBtn.disabled = false;
                        cancelBtn.innerHTML = '<span class="flex items-center gap-1"><svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>Cancel</span>';
                    }
                }
            } catch (error) {
                console.error('Error cancelling build:', error);
                alert('Error cancelling build: ' + error.message);
                if (cancelBtn) {
                    cancelBtn.disabled = false;
                    cancelBtn.innerHTML = '<span class="flex items-center gap-1"><svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>Cancel</span>';
                }
            }
        }

        // Debug: Log when page loads
        console.log('Pipeline page loaded. Build ID:', buildId, 'Initial status:', currentBuild.status);
        console.log('SSE supported:', !!window.EventSource);
    </script>
</body>

</html>